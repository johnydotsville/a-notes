# Предисловие

Когда я писал конспекты про конкретные действия, вроде добавления и удаление файла из индекса, восстановление содержимого файла, восстановление удаленного файла и т.д., то там была цель кратко описать рецепты, какой командой что можно сделать. Чтобы можно было, если вдруг все механики забыл, просто открыть конспект, быстро найти нужное действие и сделать без заморочек и перечитываний.

Но поскольку разные с виду действия выполняются по сути одной и той же командой, обязательно нужно было написать, почему это так происходит. Т.е. описать механику, которая за этой командой стоит. Я решил сделать это в отдельном конспекте - в этом. Пусть те конспекты останутся "наивными", в стиле "нажми на кнопку - получишь результат", а в этом - разберемся как это все работает.

# add vs restore

## "Прямой" путь

Типичный путь, который проходит файл, это "рабочая директория > индекс > коммит":

* `git add` - добавляет файл из рабочей директории в индекс.
* `git commit` - добавляет файл из индекса в коммит.

Можно условно назвать это "прямой" путь. Типичный сценарий - мы создали в проекте файл с новым классом и хотим его сохранить. Поэтому добавляем его в индекс и делаем коммит. Или наоборот - какой-то файл стал нам не нужен, мы его удаляем, добавляем в индекс это удаление и делаем коммит.

## Обратный путь

Но файл может проходить и обратный путь, т.е. "коммит > индекс > рабочая директория".

Например, мы отредактировали файл, добавили изменения в индекс, потом еще раз отредактировали и поняли, что хотим откатить изменения. Тогда мы можем взять версию файла из индекса и вернуть ее в рабочку. Или если мы закоммитили файл, а потом поняли, что хотим вернуть его в состояние, как в каком-то другом коммите, то мы можем взять его из конкретного коммита, поместить в индекс, а потом взять уже из индекса к себе в рабочую директорию.

Этот "обратный" путь делается командой git restore:

* `git restore --staged` - двигает файл из коммита в индекс.
  * Коммит может быть либо последний, либо какой-то конкретный.
* `git restore` - двигает файл из индекса в рабочку.

#  Удаление - это восстановление

"Война - это мир, свобода - это рабство, удаление - это восстановление".

"Удаление - это восстановление" можно понять на таком примере: мы создали в рабочке новый файл `foobar.ts` и добавили его в индекс. Потом решили, что этот файл нам не нужен и удалили его из рабочки. Но он остался в индексе. Удалить его оттуда можно командой `git restore --staged foobar.ts` Это пример выражения "удаление - это восстановление". Технически, командой git restore --staged мы пытаемся восстановить состояние файла foobar.ts из последнего коммита. Но его в коммите нет! Т.е. можно сказать, что у этого файла состояние "отсутствует, не существует". Соответственно, git restore --staged приводит файл в индексе в аналогичное состояние - "отсутствует, не существует", т.е. фактически удаляет.

![delete-is-restore.drawio](img/delete-is-restore.drawio.svg)

# Удаление - это добавление

Удаление, это не только восстановление. Удаление - это еще и добавление.

Пример такой: у нас есть какой-то файл в проекте, который уже был закоммичен сто лет назад, но теперь он нам не нужен. Мы удаляем его из рабочей директории, затем добавляем "действие удаления" в индекс, а потом коммитим это удаление и т.о. файл удаляется из проекта.

![delete-is-add.drawio](img/delete-is-add.drawio.svg)

Этот пример показывает, что между областями могут путешествовать не только файлы, но и как бы действия. Хотя мы фактически удаляем файл из рабочки, но должны добавить его в индекс после этого, чтобы указать гиту намерение удалить его. А если мы вдруг удалили его по ошибке, то мы можем с помощью restore восстановить его из коммита в индекс, а потом из индекса уже восстановить в рабочку.

![restore-example.drawio](img/restore-example.drawio.svg)

# Заключение

Трудно сказать, насколько понятным это все будет потом. Время покажет.

Но мне кажется, что если понять эти две вещи:

* Файл может двигаться в двух направлениях:
  * "Рабочка > индекс > коммит".
  * "Коммит > индекс > рабочка".
* Файлы - это не только файлы, но их состояния.
  * Если файла нет или он удален, можно сказать, что это "Файл в состоянии `"отсутствует"`".

Если понять эти две вещи и запомнить, что add - это движение "туда", а restore - это движение "обратно", тогда все сценарии использования этих команд станут весьма логичными.