# Docker Compose

Docker Compose - это инструмент, который позволяет разом запустить несколько контейнеров, чтобы не поднимать их по очереди руками из командной строки. Может быть полезно в случаях когда для работы одного контейнера нужен другой. Например, если приложению для работы одновременно нужен ngnix и mysql, то вместо того, чтобы поднимать их по-отдельности, можно с помощью docker compose запустить разом и в нужном порядке. Или кафка, которая работает вместе с зукипером.

DC в линуксе нужно устанавливать отдельно, а в винде он ставится автоматически вместе с docker engine при установке gui клиента докера.

Проверить установку и узнать версию можно командами:

```
docker-compose -v
docker-compose version
```

# Пример

Настройка dc производится в файле `docker-compose.yaml` (или yml), это название по умолчанию. Можно называть и по-другому, но тогда будет отличаться использование некоторых команд (будет дальше). Файл этот можно положить куда угодно.

В нем указываются сервисы, конфиги, сети, секреты, тома. Сервисы - это собственно говоря и есть приложения, которые должны работать вместе.

Простой пример docker-compose.yaml для запуска кафки и зукипера:

```
version: '2'
services:
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - 22181:2181
  
  kafka:
    image: confluentinc/cp-kafka:latest
    depends_on:
      - zookeeper
    ports:
      - 29092:29092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
```

## Запуск

Чтобы запустить все контейнеры, описанные в файле:

```
docker-compose -f "e:\tmp\docker-compose.yaml" up -d
```

* `-d` - detached mode, может быть вреден, т.к. в консоль не будет выводиться информация о процессе запуска.

## Остановка

Запущенные контейнеры можно разом остановить из GUI. Чтобы сделать это из терминала, нужно перейти в директорию с файлом docker-compose.yml, в котором описано то, что мы запускали, и из этой директории выполнить:

```
docker-compose stop
```

Если файл называется не по умолчанию, используется другая команда (и при этом уже не обязательно переходить в директорию с файлом, но тогда придется писать полный путь до него):

```
docker-compose -f kafka-cluster-experiment.yml down
```

# Полезные тонкости

## Порядок запуска сервисов

Через `depends_on` мы можем указать докеру, в какой последовательности он должен запускать сервисы. Однако докер не способен понять, нормально ли поднялся сервис с точки зрения бизнес-логики, например, произошло ли соединение с БД и все в этом роде. Он ориентируется на свои технические факты - запустилось, значит все нормально, запускаю следующий.

Поэтому нужно писать приложения таким образом, чтобы они в случае чего сами предпринимали попытки переподключиться к БД или опросить другой сервис на предмет корректной работы.

## Независимость контейнеров

Каждый контейнер, работающий в докере, работает сам по себе, как бы на собственном "компьютере" *внутри* докера. Поэтому сервисы общаются внутри докера исключительно по сети (опять же, по собственной внутренней сети докера). Нет никакого единого "localhost" внутри докера - в каждом контейнере "localhost" указывает на этот же контейнер (понятия локалхост там тоже нет, просто для аналогии упомянуто). И "localhost" компьютера, на котором запущен докер, так же не имеет никакого отношения к контейнерам, работающим в докере (особенно понимание этих вещей критично при работе с кафкой, когда она запущена в докере, а наши программы мы запускаем на своем компьютере, "хосте").

Поскольку каждый работающий контейнер - самостоятельная единица, то у каждого - свой набор портов. Это значит, что даже если десять контейнеров работают в одной сети докера, каждый из них может использовать порт, например, 49092. Но если они этот порт экспозят на хост (компьютер, где работает докер), тогда уже экспозить надо под разными номерами, например:

```
service1:
  ports:
    - 49092:49092
service2:
  ports:
    - 49093:49092
service3:
  ports:
    - 49094:49092
```