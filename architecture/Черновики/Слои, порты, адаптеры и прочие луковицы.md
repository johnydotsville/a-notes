# Ссылки, которые встретились по мере составления документа

https://matthiasnoback.nl/2017/08/layers-ports-and-adapters-part-2-layers/

http://wiki.c2.com/?StableDependenciesPrinciple

# Слои

Слои - это способ классификации и организации компонентов приложения. Слои позволяют сформировать структуру приложения так, что концептуально похожие по своему назначению компоненты находятся на одном слое и не перемешиваются с концептуально отличающимися компонентами, в результате чего в приложении проще ориентироваться.

Кроме организации компонентов слои выполняют и другие функции:

* Фильтрующую - слой предоставляет клиенту доступ к определенной функциональности с помощью своего API. Так что клиент не может прорваться "сквозь" этот слой в более глубокие слои и получить напрямую какой-то функционал, который для него не предусмотрен с точки зрения архитектуры.
* Валидирующую и форматирующую - если сквозь слой что-то прошло, то это что-то с точки зрения слоя - корректное и может использоваться дальше. Слой подготавливает это что-то в формат, подходящий более глубокому слою.

## Виды слоев

Джентельменский набор слоев это:

* Domain (доменный)
* Application (прикладной)
* Infrastructure (инфраструктурный)

### Domain

Доменный слой - это все, что определяет ядро приложения. Тот самый уникальный функционал, ради которого пишется программа. Как следствие, все находящиеся в этом слое компоненты являются "чистыми" - они не зависят ни от каких сторонних библиотек, технологий и т.д. Поэтому их не должно составить труда проверить юнит-тестами, передав им простые данные и зависимости от других компонентов домена. Все, что может находиться в домене - это наша выдумка и стандартная библиотека.

UPD. Еще можно использовать зависимости, которые считаются стабильнее нашего собственного кода, т.е. вероятность их изменения крайне мала. Принцип "Stable Dependencies Principle" http://wiki.c2.com/?StableDependenciesPrinciple Менее стабильные зависимости должны зависеть от более стабильных, но не наоборот.

### Application

Содержит классы команд и обработчиков. Команды - это DTO-объекты с примитивными значениями. Команды (они же application services) умеет эти команды выполнять. Он использует данные из команды для создания (или извлечения из БД) аггрегатов, выполняет над ним операции и сохраняет его.

TODO: сервисы уровня приложения

Тестируется с помощью юнит-тестов и приемочных (acceptance tests)

TODO: Примеров не было, как выглядит команда и как обработчик. Оставлена ссылка https://stakeholderwhisperer.com/posts/2014/10/introducing-modelling-by-example мб там что-то найдется.

### Infrastructure

Этот слой соединяет код из прикладного слоя с "реальным миром".

TODO: Пишут про "работа с HTTP", общение с БД, т.е. складывается впечатление, что раз http, то вероятно тут расположены контроллеры с эндпоинтами, а также конкретная реализация работы с БД. Но не понятно, как именно выглядит эта связь. Грубо говоря, где-то на слое ниже например есть интерфейс сохранения какого-то объекта, а на этом слое реализация этого сохранения? Или что? Также тут упоминается "Генерация случайных чисел". Это что значит? Что какие-то хелперы находятся тут, даже если они нужны ядру? Не понятно.

Понятно только то, что это первый слой, где мы можем уже работать с библиотеками и фреймворками. Все, что лежит глубже, данный функционал должно получать через собственно-объявленные абстракции.

### Слои и зависимости

Каждый слой зависит только от себя и от более глубокого слоя.

Домен - только от себя. Прикладной - от себя и от домена. Инфраструктурный - от себя и от прикладного. TODO: а напрямую еще и от домена может или нет?

Зависимости реализуются через интерфейсы. Интерфейс НЕ должен лежать в том же модуле, где лежит его реализация. Интерфейс должен лежать в том модуле, которому он нужен, либо в каком-то промежуточном модуле. Вспомнилась книга МакЛина по .net, где он предлагал интерфейсы класть в отдельную сборку и ставить зависимость на нее из всех других мест, где интерфейс нужен.

Замечания из каментов: в статье не предлагается выделять отдельный ui layer поскольку он  является частью инфраструктуры. "порты и адаптеры" в заголовке как бы  намекают, хотя статья этот вопрос вообще не раскрывает. Вы можете  разделять слой инфраструктуры и выделять там и UI layer, и DAL и т.д. но это уже вам решать. Опять же если сразу идти по пути полного разделения то будем есть лазанью. 

В целом достаточно только двух слоев, намного важнее направление зависимостей между ними соблюдать.



# TODO

Термины, которые могут вывести на смежные темы:

* Bounded context - шаблон, есть у [Мартина Фаулера](https://martinfowler.com/bliki/BoundedContext.html).
* Прочие ддд-шные паттерны:
  * Entities
  * Value objects
  * Агрегаты
  * Domain events
  * Repositories
  * Domain services
  * Factories
* persistence ignorance
* event-driven дизайн
* контракт, культ карго
* Схемы Infrastructure->Application->Domain и Presentation->Application->Domain->Infrastructure
* Границы бизнес-транзакций