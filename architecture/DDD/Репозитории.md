# Репозитории

## Предисловие

Между сущностями определенно есть взаимосвязи. Например, есть связь между сущностью Покупатель и Заказ. У каждого покупателя есть какие-то заказы, а каждый заказ принадлежит какому-то покупателю. Соответственно, имея на руках объект покупателя, мы логически можем определить и все его заказы. А имея заказ, мы можем определить покупателя.

Вопрос только в том, как это реализовать технически, чтобы было и удобно, и не получилось слишком много связей. Например, возникают такие вопросы в отношении того, как в итоге должны выглядеть сформированные объекты:

* Должен ли объект Покупатель содержать в себе список всех связанных с ним заказов? В виде непосредственно объектов Заказ или просто их идентификаторов - не важно. Важна сама суть - должен ли покупатель непосредственно держать в себе такой список.
* Должен ли объект Заказ содержать в себе покупателя? Опять же, в виде объекта Покупатель или только идентификатора - не важно.

Извлечение объекта из хранилища - это частный случай создания объекта. Потому что мы создаем объект в памяти, наполняя его извлеченными данными.

 ## Назначение репозитория

Репозиторий скрывает в себе техническую реализацию сохранения и восстановления объектов в конкретную СУБД. Репозиторий представлен интерфейсом в доменном слое и реализацией этого интерфейса в инфраструктурном слое.

Репозиторий предоставляет все логические операции, которые могут понадобится в отношении сущности: сохранение, поиск по разным критериям, какие-нибудь статистические операции (получение среднего значения, минимально-максимального и т.д.). В результате написания хорошего репозитория вся логика работы с конкретной СУБД инкапсулирована внутри репозитория и благодаря этому на прикладном и доменном уровнях можно программировать в терминах модели, а не в терминах технологии хранения.

Для особо сложных запросов может быть организована специальная гибкая система. Например, введено понятие Критерий (Спецификация) и метод репозитория, принимающий такой критерий, переводящий его в термины СУБД и возвращающий подходящие объекты.

Простые запросы или, правильнее сказать, наиболее популярные запросы лучше всего оформлять в виде явных методов репозитория. Например "Уволенные сотрудники", "Сотрудники в декрете", "Руководители подразделений". Такие отдельные методы переводят запросы на более высокий уровень абстракции и позволяют скрыть детали конкретного условия отбора.





# Интересные мысли

* "Оставьте контроль транзакция клиенту". Эванс предлагает в разделе "Реализация хранилища" оставлять обязанность управления транзакциями клиенту, т.к. сценарий работы может быть сложный и задействовать несколько хранилищ.
* Репозитории не требуют от РСУБД принципа "один объект - одна таблица" (раздел "Проектирование объектов для реляционной базы данных"). Возможно использование агрегации, сборки объекта из нескольких. Но обычно так: Строка таблицы должна содержать объект - возможно, вместе с его подобъектами в виде АГРЕГАТА. Внешний ключ в таблице должен транслироваться в ссылку на другой объект-СУЩНОСТЬ.

# TODO

* Нужно еще разобраться с понятием агрегата, потому что репозитории с ним тоже связаны.
* Связь фабрики и репозитория в разделе "Связь с фабриками". Перечитать позже, когда разберусь с фабриками.