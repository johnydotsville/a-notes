# Persistence context

## Фабрика, интерфейс EntityManagerFactory

Создание фабрики - тяжелый процесс, поэтому фабрику создают единожды на старте программы, а контекст можно вполне создавать почаще, например, для каждого веб-запроса.

## Контекст, интерфейсы EntityManager и Session

Persistence context, или просто *контекст*, в JPA представлен интерфейсом `EntityManager` (а в хибере - `Session`). Это основной интерфейс в JPA для обращения с данными. Мы создаем контекст с помощью фабрики, выполняем какую-то работу и в конце закрываем контекст. Т.о. мы сами определяем время жизни контекста:

```java
// <-- Создаем фабрику
EntityManagerFactory factory = Persistence.createEntityManagerFactory("dvdrental-pu");

// <-- Создаем контекст с помощью фабрики
EntityManager em = factory.createEntityManager();

EntityTransaction tr = em.getTransaction();
try {
    tr.begin();
    // Выполняем какую-то работу
    tr.commit();  
} catch (Exception ex) {
    System.out.println("Откат транзакции");
    tr.rollback();
} finally {
    if (em != null && em.isOpen()) {
        em.close();  // <-- Закрываем контекст
    }
}
```

Контекст работает с пулом соединений JDBC, извлекая соединение из пула только тогда, когда надо выполнить запрос. Т.о. само создание контекста никак не трогает БД. Можно создать, закрыть контекст и при этом к БД вообще не будет ни одного обращения.

Контекст реализует паттерн unit of work. Он отслеживает сущности и синхронизирует их с БД. Синхронизация (`flush`) заключается в том, что хибер с помощью sql-команд вроде insert, update, delete вставляет новые сущности в БД, удаляет те, которые помечены на удаление, и обновляет измененные. Синхронизация  может происходить в разные моменты в зависимости от выбранного режима и выполняемых операций. Подробнее о том, каким образом хибер понимает, изменилась ли сущность, а также о моментах, когда выполняется синхронизация, написано в отдельных конспектах.

