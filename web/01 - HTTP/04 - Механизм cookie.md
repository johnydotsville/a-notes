https://www.kaspersky.ru/resource-center/definitions/cookies

# Официальная документация

Про куки и не только можно почитать тут: https://www.rfc-editor.org/rfc/rfc6265

# Что такое cookie

Куки - это текстовые данные, которые пересылаются в заголовках HTTP-запроса между клиентом и сервером. Эти данные обычного небольшого размера (более конкретно см. раздел про ограничения на куки), имеют формат "ключ-значение". Хранятся на клиентском компьютере в текстовых файлах или в оперативной памяти, в зависимости от типа. 

Термин "cookie" не имеет специального значения.

# Для чего используют cookie

Поскольку HTTP сам по себе - это stateless-протокол, то куки можно использовать для обеспечения хранения состояния работы пользователя с сайтом. Например:

* Куки часто используются при аутентификации. Когда клиент первый раз обращается к серверу, то сервер присылает браузеру идентификатор сессии. Браузер сохраняет его в куку и шлет с последующими запросами серверу. Так сервер понимает, что это не новый пользователь подключился, а уже работающий.
* Разные настройки сайта: язык, город, используемая валюта (например, для интернет-магазинов)
* Данные авторизации: логин и пароль.
* Личные данные: номера телефона, адрес, платежные данные.
* Данные об устройстве: версия браузера, модель устройства.
* Информация о взаимодействии с сайтом: сколько времени проведено на сайте, по каким баннерам кликали и т.д.

# Механика появления и передачи кук

Впервые кука создается в браузере. В общих чертах процесс возникновения куки выглядит так:

* Браузер посылает на сервер какой-то запрос.

* Сервер возвращает ответ, в котором, среди прочих заголовков, может присутствовать заголовок `Set-Cookie` (или несколько таких заголовков, если надо создать несколько кук). Куки-заголовки в ответе выглядят примерно так:

  ```java
  Set-Cookie: key1=value1; expires=Mon, 17-Jul-2017 16:06:00 GMT; Path=/; secure
  Set-Cookie: key2="value2"; Max-Age=31449600; Path=/; secure; SameSite=Strict; HttpOnly
  ```

* Видя заголовок Set-cookie в ответе, браузер понимает, что надо создать куку.

* Он ее создает и хранит у себя, и отправляет на сервер в заголовке `Cookie` с каждым очередным запросом. Куки отправляются только на тот сервер, который приказал браузеру создать ее. Если кук несколько, все они идут через `;` в одном заголовке. Пример запроса с куки-заголовком, который клиент посылает на сервер:

  ```java
  GET /spec.html HTTP/1.1
  Host: www.example.com
  Cookie: foo=10; bar=20  // <-- Вот они, несколько кук в одном заголовке
  Accept: */*
  ```

# Формат кук

Вот пример заголовка, содержащего куки:

```
Set-Cookie: key1=value1; expires=Mon, 17-Jul-2017 16:06:00 GMT; Max-Age=31449600; Path=/; secure
Set-Cookie: key2="value2"; Max-Age=31449600; Path=/; secure; SameSite=Strict; HttpOnly
```

Куки хранятся в формате ключ-значение, причем значение может быть заключено в кавычки, если надо. После этого идут *атрибуты* куки, например:

* Max-Age или expires - время жизни куки.
* HttpOnly - запрет получать значение куки через Javascript.
* sercure - возможность отправлять куку только через Https с использованием SSL.

 Атрибутов довольно много, это отдельная тема.

# Работа с куками из Javascript

Работа с куками из Javascript осуществляется через свойство `document.cookie`. Это не просто свойство, а аксессор, т.е. по сути метод.

Все куки хранятся в виде единой строки, в формате пар `имяКуки=значениеКуки`, разделенных `;`. Отдельных стандартных методов для работы с куками нет, все делается через манипуляцию над этой строкой. Поэтому для удобства работы с куками обычно используются библиотеки, вроде `js-cookie`.

Так выглядит строка из двух кук (без атрибутов):

```
username=Tom%20Sawyer; age=14
```

# Область доступности кук

По умолчанию область доступности кук - это ориджин + path. Это значит, что кука доступна странице, которая ее создала, а также другим страницам из этой же директории и поддиректорий.

Например, кука создана для страницы `foobar.com/catalog/index.html`. Тогда она будет доступна также для страниц `foobar.com/catalog/clothes.html` и `foobar.com/catalog/men/shoes.html`. Но не доступна странице `foobar.com/about.html`

Это поведение можно корректировать, если задать куке атрибуты path и domain. Но в любом случае предел доступности - это субдомен. Сделать ее доступной для другого домена невозможно.

# Ограничения на количество и размер кук

Браузеры должны обеспечивать такие [минимальные требования](https://www.rfc-editor.org/rfc/rfc6265#section-6.1) к хранению кук:

* Размер куки:
  * Хотя бы 4096b для одной куки (на ключ и на значение суммарно, атрибуты в этот лимит не входят).
* Количество кук:
  * Хотя бы 50 кук на домен.
  * Хотя бы 3000 кук всего.

Сервера должны по возможности использовать как можно меньше кук и чтобы они были как можно меньше.

# Время жизни кук

По времени жизни куки делятся на два вида:

* `Permanent cookie` ("со сроком годности") - эти куки существуют заранее определенный промежуток времени, в течение которого браузер продолжает их хранить и отправлять, а по истечении этого промежутка - удаляет.

  Перманентные куки создаются, когда сервер присылает куку с атрибутом *Expires* или *Max-Age*.

* `Session cookie` - такие куки существуют и отправляются, пока открыт браузер. Они хранятся в оперативной памяти. Если браузер закрыть, то сессионные куки удаляются. Но в браузерах обычно есть опция восстановления сеанса (галочка "Открывать предыдущие окна и вкладки"), при которой сессионные куки тоже восстанавливаются и могут существовать, пока их например не удалят вручную.

По умолчанию куки являются временными.

# Атрибуты кук

## expires и max-age

С помощью этих атрибутов можно задать "срок годности" куки. Когда он проходит, браузер удаляет куку.

Если не установить ни один из этих параметров, кука считается *сессионной* и удалится после закрытия браузера (не страницы, а именно браузера целиком как программы). Однако, если в браузере стоит галочка "Восстанавливать вкладки", тогда при повторном запуске он восстановит сессию и сессионная кука тоже восстановится.

* `max-age` - задает срок годности в секундах.
* `expires` - задает срок годности в виде даты. Более старый атрибут.

Если заданы оба атрибута, то max-age имеет приоритет. Поскольку expires использует дату, а у сервера и клиента могут быть разные даты (например, разные часовые пояса), то это может привести к ошибкам. Поэтому max-age считается более надежным.

## path и domain

По умолчанию кука доступна только для страницы, которая ее установила. Но можно это поведение скорректировать через атрибуты `path` и `domain`.

P.S. Библиотеки для работы куками могут менять описанное ниже дефолтное поведение. Например, js-cookie по дефолту ставит path в `/`, что делает куку доступной сразу на всем домене.

### path

С помощью `path` можно расширить количество страниц, которым будет доступна кука. Например, если кука установлена на странице `foobar.com/dir1/index.html`, то это значит, что по умолчанию эта кука будет также доступна на страницах `foobar.com/dir1/index.html` и `foobar.com/dir1/dir1a/index.html`. Т.е. для страниц в той же директории и субдиректориях.

Если установить path в значение `/dir2`, тогда кука будет видна, например, таким страницам как `foobar.com/dir2/index.html` и `foobar.com/dir2/dir2b/index.html`. Т.е. к дефолтной области видимости добавится еще и указанная.

Если установить path в `/`, тогда кука будет видна всем страницам в домене.

### domain

С помощью `domain` можно расширить количество доменов, которым видна кука. Однако это работает только для субдоменов. Например, если кука установлена на какой-нибудь странице в домене `foobar.com`, то если мы установим domain в `.foobar.com`, тогда кука станет доступна в `abc.foobar.com` и `zxc.foobar.com`. Но мы не можем сделать так, чтобы она стала доступна, например, в `qwerty.com`, т.к. это совершенно другой домен.

## secure

Если этот атрибут присутствует, это значит что куку можно отправлять только по HTTP**S**.

P.S. Как запомнить: **S**ecure - значит http**S**.

## httponly

Если этот атрибут присутствует, то куку невозможно прочитать программно через Javascript, т.е. через document.cookie. Некоторые куки клиенту лучше не читать. Например когда кука содержит идентификатор сессии, то чтение и воровство идентификатора может быть опасным. HttpOnly куки дают дополнительную защиту от XSS-атак.

Для кук, которые содержат менее чувствительную информацию, вроде содержимого корзины в магазине, флаг httpOnly не нужен, т.к. клиентскому коду требуется возможность модифицировать такие куки.

## samesite

Имеет три значения:

* `samesite=strict` - или просто samesite. Означает, что кука может передаваться только в пределах домена, который ее создал.
* `samesite=none` - нет ограничений.
* `samesite=lax` - кука может передаваться только методами GET, HEAD, OPTIONS, TRACE.

## Прочие

Оставшиеся атрибуты, которые в TODO:

```
Priority
Site/Service
SourcePort
StoragePartition
Size
```

