# Движок и среда

*Движок* Javascript - это программа, которая понимает код, написанный на Javascript и выполняет его. В задачу движка входит JIT-компиляция.

> JIT-компиляция (just-in-time, "вовремя") это вид компиляции, когда она производится не заранее, перед запуском программы, а непосредсвенно во время ее работы. Подлежащий выполнению фрагмент исходного кода компилируется единожды и впоследствии, если снова нужен, то повторно компилировать его не приходится. JIT-компиляция позволяет добиться лучшей оптимизации программы, поскольку комплилятору уже известно, в каком именно окружении программа выполняется.

Известные движки:

* V8 - используется в браузере Chrome и среде Node JS.
* SpiderMonkey - используется в браузере Firefox.

Примеры *среды* выполнения:

* Браузер.
* Node JS.

В обязанности среды входит:

* Предоставление API. Например, для браузера это работа с DOM, а для Node JS - работа с файлами. Ввод\вывод и прочая функциональность - тоже предоставлена средой, а не движком.
* Реализация дополнительных вещей, предназначенных для организации выполнения js-кода, например Event Loop.

# Event Loop

Event Loop реализован в среде выполнения (браузер, node js) и не является частью движка или языка. Про EL в браузере можно почитать спецификацию [здесь](https://html.spec.whatwg.org/multipage/webappapis.html#event-loop).

Сильно пытаться разобраться как работает луп я не буду, т.к. судя по [комментарию](https://habr.com/ru/articles/762618/#comment_26066934) опять скорее всего встречу только заблуждения, мифы и байки, а копать до истины нет времени и необходимости. Поэтому буквально в двух словах опишу идею, которая с виду проста.

В ходе выполнения скрипта встречаются синхронные и асинхронные функции. Например, console.log - это синхронная функция, а fetch - асинхронная. Синхронные функции собираются в *стек*, а асинхронные - помещаются в отдельные *очереди*, так называемые [task queue](https://html.spec.whatwg.org/multipage/webappapis.html#task-queue) и [microtask queue](https://html.spec.whatwg.org/multipage/webappapis.html#microtask-queue). Event Loop организует циклическую проверку этих очередей и выполнение функций из них в определенном порядке. Каков именно это порядок - зависит от реализации лупа. Например, условно он может разделить функции на "микро задачи" и "макро задачи". Выполнить сначала все микро-задачи, потом одну макро-задачу, а затем проверить, не появились ли новые микро. Если появились, выполнить их, потом взять еще одну макро. А если не появились, то сразу взять макро. Как именно это работает - не столь важно. Важно только понять, что суть лупа - организовать их работу так, чтобы они все выполнились. Подлежащую выполнению функцию он помещает в стек.

