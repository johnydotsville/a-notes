# Преобразование в примитив

Преобразование объекта в примитив происходит в тех случаях, когда например объект попадает в функцию, которая требует строку, или над объектами производят математические операции.

Мы можем написать для объекта следующие правила преобразования:

* В строку.
* В число.
* К логическому типу - не можем, потому что в логическом контексте объект всегда считается true.

Существует два способа предоставить реализации преобразований:

* Современный способ, через Symbol.
* По старинке, через методы `toString()` и `valueOf()`

# Реализация преобразования

## Функция преобразования и хинты

В спецификации Javascript обозначена абстрактная функция преобразования `ToPrimitive`, которая принимает объект, подлежащий преобразованию и т.н. "хинт" (в виде строки), который может принимать следующие значения:

* `string` - если оператору нужно преобразовать объект в строку (например, вывод в alert).
* `number` - если оператору нужно преобразовать объект в число (например, оператор вычитания).
* `default` - если оператор работает и со строками, и с числами (например, сложение) и следовательно не понимает, во что именно нужно преобразовать объект.

Где именно "зарождается" хинт я искать не стал, важно только понимать, что он попадает в эту функцию, а она уже на его основе пытается найти во входном объекте конкретную функцию преобразования.

## Через Symbol

Есть специальный символ `Symbol.toPrimitive`. Используя его, мы можем добавить в объект функцию, которая будет вызываться для преобразования в примитив. Функция имеет единственный параметр - тот самый "хинт", о котором говорилось выше:

```javascript
let user = {
  name: "Tom",
  age: 14,

  [Symbol.toPrimitive](hint) {  // <-- Добавляем функцию, имя которой вычисляется из символа
    return (hint == "string") ? this.name :  // <-- Для каждого вида хинта пишем преобразование
      (hint == "number") ? this.age :
      this.age;
  }
};

alert(user);  // "Tom"

let sum = user + user;
console.log(sum);  // 28
```

Функцию можно приделать любым доступным способом, как и любую обычную функцию:

```javascript
let user = {
  name: "Tom",
  age: 14
};

user[Symbol.toPrimitive] = function(hint) {
  return (hint == "string") ? this.name :
    (hint == "number") ? this.age :
    this.age;
}
```

## Через методы toString() и valueOf()

Когда нет "символьного" метода, то движок для выполнения преобразования пытается найти методы `toString()` и `valueOf`. Выбор метода и очередность поиска зависит от хинта:

* `string` - если хинт string, то сначала движок ищет функцию `toString()`, а если ее нет, то `valueOf()`.
* `number` или `default` - если хинт не string, то движок ищет `valueOf()`, а потом `toString()`.

Т.о. видно, что метод toString вызывается гарантированно, поэтому если нужно общее правило преобразования объекта в примитив, то его можно описать в этой функции.

Дефолтная реализация toString возвращает строку "[object Object]", а valueOf просто возвращает сам объект.

Итак, напишем реализацию методов:

```javascript
let user = {
  name: "Tom",
  age: 14,

  toString() {  // <-- Для хинта string
    return this.name;
  },

  valueOf() {  // <-- Для хинтов number и default
    return this.age;
  }
};

alert(user);

let sum = user + user;
console.log(sum);
```

Импровизация:

```javascript
let user = {
  name: "Tom",
  age: 14,

  toString() {
    return this.name;
  }
};

user["toString"] = function() {
  return "ПЕРЕОПРЕДЕЛЕНО! " + this.name;
};

user["valueOf"] = function() {
  return this.age;
};

alert(user);

let sum = user + user;
console.log(sum);
```

## Особенности преобразования

* Функции toString и valueOf должны возвращать примитивы, но не важно, какие именно. Т.е. функция toString может вернуть не строку, а число. Это движок никак не проверяет.
* Если toString или valueOf вернут не примитив, а объект, то это породит ошибку "Cannot convert object to primitive value". Аналогично и с методом Symbol.toPrimitive.