# Изоляция стилей

Когда проект большой, то много селекторов могут иметь одинаковые имена, вроде `.open`. Из-за этого они будут накладываться друг на друга и конфликтовать. Даже именование по БЭМ может приводить изредка к конфликтам.

Поэтому существует т.н. изоляция стилей. При сборке вебпак переименует селекторы в хэши и т.о. имена получатся гарантированно уникальными.

# Реализация

## Структура проекта

```
project_root/
    src/
        components/
            App.module.scss
            App.tsx
        index.tsx
    global.d.ts  // <-- Для глобальных интерфейсов, чтобы работал импорт, см. дальше.
    webpack.config.js
    tsconfig.json
    package.json
```

## Файл стилей

В имя файла со стилями надо добавить суффикс `module`, например `App.module.scss`:

```css
h1 {
  color: red;
  background-color: aquamarine;
  font-size: 40px;
}

.message {
  color: green;
  background-color: bisque;
  font-size: 20px;
  padding-left: 80px;
}
```

## Файл компонента

Для использования стилей в компоненте, импортируем их в объект и все селекторы становятся полями этого объекта (см. конспект по реакту как это работает):

```react
import * as classes from "./App.module.scss";  // <-- Импортируем стили

export const App = () => {
  return (
    <div>
      <h1>Hello, world!</h1>
      <p className={classes.message}>Раз прислал мне барин чаю и велел его сварить.</p>
    </div>
  )
}
```

Для задания класса используем синтаксис с фигурными скобками `{имяОбъекта.селекторИзФайлаСтилей}`. Селекторы по тегам применяются автоматически, для них ничего писать в разметке не надо.

### global.d.ts

Добавляем в корень проекта файл с именем `global.d.ts` с таким содержимым:

```typescript
declare module "*.module.scss" {  // <-- Внимание на расширение!
  interface IClassNames {
    [className: string]: string
  }
  const classNames: IClassNames;
  export = classNames;
}
```

Он нужен, чтобы в компоненте работал вот такой импорт `import * as classes from "./App.module.scss";`.  Если препроцессор не используется, указываем расширение css.

> Судя по экспериментам, этот файл не обязательно класть в корень. Как будто можно положить его куда угодно и все равно работает.

## webpack.config.js

В конфиге вебпака нужно добавить в css-loader некоторые настройки, чтобы имена стилей, примененные к элементам, заменялись на другие. В случае dev-сборки, будет удобно видеть длинное имя с путем до файла стилей, а в случае prod-сборки - короткое на основе хэша:

```javascript
const MiniCssExtractPlugin = require("mini-css-extract-plugin");

module.exports = (settings, argv) => {
  const isDev = argv.mode === "development";

  const cssLoaderWithModules = {  // <-- Настраиваем лоадер.
    loader: "css-loader",
    options: {
      modules: {  // <-- Нужна опция localIdentName
        localIdentName: isDev ? "[path][name]__[local]" : "[hash:base64:8]"
      },
    },
  }

  const miniCss = new MiniCssExtractPlugin({  // <-- Просто для удобства наблюдения за результатом.
    filename: "css/[name].[contenthash:8].entry.css",
    chunkFilename: "css/[name].[contenthash:8].css"
  });
  
  return {
    module: {
      rules: [
        {
          test: /\.s[ac]ss$/i,
          use: [
            isDev ? "style-loader" : MiniCssExtractPlugin.loader,  // <-- Для удобства наблюдения.
            cssLoaderWithModules  // <-- Применяем настроенный лоадер.
          ]
        },
        // Остальные типы файлов
      ],
    },
    plugins: [
      htmlWebpack,
      isProd ? miniCss : false
    ],
    // Остальная часть конфига
  }
};
```

Как будут выглядеть стили:

* Конструкция `[path][name]__[local]` даст имя вроде `src-components-App-module__message`:
  * Структура названия:
    * `scr-components` - это path.
    * `App-module` - это name.
    * `message` - это селектор внутри самого файла стилей.
  * Эти имена можно увидеть внутри файла бандла. При dev-сборке стили в данном случае будут частью бандла.
* Конструкция `[hash:base64:8]` даст имя вроде `z2KE00Yy`.
  * Это имя можно увидеть в извлеченном файле стилей, который получился благодаря плагину MiniCssExtractPlugin. Не знаю, как именно считается этот хэш, но он уникальный, т.е. для каждого селектора эта конструкция даст неповторяющиеся имена.

Про localIdentName можно почитать [тут](https://webpack.js.org/loaders/css-loader/). Пока необходимости читать детально вроде бы нет.