# Транзакции

Физически, **транзакция** - это последовательность операций над БД, которая переводит ее из одного согласованного состояния в другое, и выполняется по принципу "все или ничего".

Логически, транзакция - это способ согласованного изменения взаимосвязанных данных, хранящихся в разных местах (нескольких таблицах или даже нескольких БД).

В транзакцию обычно объединяются операции, которые должны непременно выполниться вместе, а если хоть одна выполниться не может, тогда все операции, которые успели выполниться, "откатываются" и БД возвращается в состояние как было до начала транзакции.

Например, перевод денег с одного счета на другой в минимальном случае включает две операции:

* Уменьшить баланс счета плательщика;
* Увеличить баланс счета получателя.

Если эти операции никак не связать, может получиться ситуация, когда деньги списались, но не зачислились. Плательщик деньги потерял, а получатель не получил. Объединение же их в транзакцию позволяет в такой ситуации откатить операцию уменьшения баланса и плательщик свои деньги не потеряет.

Транзакция использует соединение с БД в течение всего времени своего выполнения и только после завершения возвращает соединение в пул.

# ACID

ACID - это набор требований к СУБД, которая поддерживает транзакции.

## A - Атомарность (Atomicity)

> Атомарность - транзакция не может быть зафиксирована частично.

Операции в транзакции выполнятся по принципу "Все или ничего". Не выполнился хоть один - откатываются все, которые успели выполниться до него (в рамках транзакции).

## C - Согласованность (Consistency)

> Согласованность - успешно завершенная транзакция переводит БД из одного согласованного состояния в другое согласованное состояние.

Согласованность (она же непротиворечивость, консистентность и т.д.) данных - это логическое понятие. Например, есть две таблицы:

````
"Товар"   (id, наименование)
"Продажи" (id, id_товара, цена_продажи, дата_продажи)
````

Примеры несогласованных данных:

* Отсутствие значения для поля `id_товара` является примером несогласованного состояния данных, потому что не понятно - что было продано.
* Отрицательное значение в поле `цена_продажи`.
* В поле `дата_продажи` при осуществлении продажи вставляется дата меньше текущей. Получается продажа "задним числом".

Какие-то требования согласованности можно обеспечить средствами СУБД, а какие-то придется реализовывать на программном уровне, если они более сложные. Например, для случаев выше можно сделать поле `id_товара` внешним ключом и тогда СУБД не позволит вставить запись с пустым значением в этом поле. На поле `цена_продажи` можно повесить ограничение `> 0`. Третий пример более сложный и вероятно его придется обеспечить не средствами СУБД, а на уровне приложения.

## И - Изолированность (Isolation)

> Изолированность - параллельно выполняющиеся транзакции не влияют на работу друг друга. Суммарный эффект параллельных транзакций такой же, как если бы они выполнялись последовательно.

В пределах транзакции согласованность данных отсутствует, потому что команды так или иначе выполняются последовательно. Но пока транзакция А не завершится, то другая транзакция В не должна видеть и тем более ориентироваться на результаты "промежуточных" операций транзакции А.

Впрочем, полная изолированность транзакций приводит к замедлению работы СУБД, поэтому существует несколько *уровней изоляции транзакций*, которые вводят некоторые компромиссы, позволяющие ускорить работу, но таящие потенциальные опасности несогласованности. Рассмотрены отдельной темой.

## D - Долговечность (Durability)

> Долговечность - результаты успешно завершенной транзакции не подвержены техническим или программным сбоям.

Если система сообщила об успешном выполнении транзакции, то никакие сбои не должны влиять на ее результаты. Результаты должны быть надежно зафиксированы и после устранения сбоев должны быть доступны.

